# 容器注入

- 在 **csingo** 框架中引入了 **容器注入** 的概念，在程序启动时会实例化 **ApplicationContainer** struct，定义一个全局的容器变量 **app**。  
- 在 **app** 变量中，存储了所有注入的变量，以此实现单例模式。
- 框架中的 **Controller**, **Service**, **Domain**, **Middleware**, **Command**, **Validator**, **Config** 都已经在 autoload 中实现了注入，只需要开发者使用 csingo 工具进行文件创建。

## autoload 目录&文件说明

- **Loader.go** 全局加载器，用于引入各模块自动加载方法调用
- **Command.go** 任务命令加载器，加载所有应用的Command
- **Config.go** 配置加载器，加载config目录中的配置
- **Controller.go** 控制器加载器，加载所有应用的Controller
- **Validator.go** 验证器加载器，加载所有应用的Validator
- **Middleware.go** 中间件加载器，加载所有应用的Middleware
- **Service.go** 应用服务加载器，加载所有应用的Service
- **Domain.go** 领域服务加载器，加载所有应用的Domain

## 自定义自动加载变量

- 在 **autoload** 文件夹内新增自定义的自动加载器，如：Test.go
- 在新增的自动加载器定义自动加载方法，并注入自定义变量 xxx.Y

```golang
package autoload

import (
	"demo/xxx"
	"gitee.com/csingo/cServer"
)

func InjectTest() {
	cServer.Inject(xxx.Y)
}

```

## 注入 & 获取

- 注入

```golang
import "gitee.com/csingo/cServer"
cServer.Inject(xxx)
```

- 获取

注入的变量，假设注入的变量位于包 xxx/yyy 中，且struct名为 zzz。即以“包名 + / + 结构体名”为标识符进行变量获取

```golang
import "gitee.com/csingo/cServer"
cServer.GetInstance("xxx/yyy/zzz")
```

- 实现细节

```golang
package cServer

type ServerContainer struct {
	Lock      *sync.Mutex
	Instances map[string]interface{}
}

func (i *ServerContainer) Save(instance interface{}) {
	i.Lock.Lock()
	defer i.Lock.Unlock()

	name := reflect.TypeOf(instance).Elem().Name()
	path := reflect.TypeOf(instance).Elem().PkgPath()
	index := path + "/" + name
	if i.Instances == nil {
		i.Instances = make(map[string]interface{})
	}
	i.Instances[index] = instance
}

func (i *ServerContainer) Get(index string) interface{} {
	i.Lock.Lock()
	defer i.Lock.Unlock()

	if _, ok := i.Instances[index]; ok {
		return i.Instances[index]
	} else {
		return nil
	}
}

func Inject(instance interface{}) {
	container.Save(instance)
}

func GetInstance(index string) interface{} {
	return container.Get(index)
}
```